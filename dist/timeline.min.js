/**
 * mobile-timeline - A timeline focused on a mobile-first strategy (i.e. vertical)
 * @version v0.0.1
 * @link https://github.com/datanews/mobile-timeline
 * @license MIT
 */
"use strict";!function(e,i){"undefined"!=typeof module&&module.exports&&"function"==typeof require?module.exports=i(require("underscore"),require("moment")):"function"==typeof define&&define.amd?define(["underscore","moment"],i):e.Timeline=i(e._,e.moment)}("undefined"!=typeof window?window:this,function(e,i){if("undefined"==typeof e)throw new Error("Underscore is a necessary dependency of Timeline: http://underscorejs.org/");if("undefined"==typeof i)throw new Error("Moment is a necessary dependency of Timeline: http://momentjs.com/");var t={},n={dateFormat:["MMM DD, YYYY","MM/DD/YYYY","M/D/YYYY","DD MMM YYYY","YYYY-MM-DD"],displayFormat:"MMM DD, YYYY",descending:!1,csvDelimiter:",",csvQuote:'"',template:'<div class="timeline-container timeline-bg-color">  <div class="mini-timeline">  <div class="mini-timeline-progress"></div>  </div>   <% if (typeof title !== \'undefined\' && title) { %>  <div class="timeline-header header-color cf">  <div class="timeline-label">Timeline:</div>   <div class="timeline-title"><%= title %></div>  </div>  <% } %>   <div class="spine-background">  <div class="spine-color spine"></div>  </div>   <div class="spine-end spine-top header-color">  <div><div class="spine-color spine-point"></div></div>  <div><div class="spine-color spine"></div></div>  </div>   <div class="group-container">  <% _.forEach(groups, function(g, gi) { %>  <div class="group">  <div class="group-label-container">  <div class="group-label spine-color">  <%= g.display %>  </div>  </div>   <div class="group-events">  <% _.forEach(g.events, function(e, ei) { %>  <div class="event" id="<%= timeline.id %>-<%= e.id %>">  <a class="event-link" href="#<%= timeline.id %>-<%= e.id %>">link</a>   <div class="event-date"><%= e.dateFormatted %></div>   <% if (e.title) { %>  <h3 class="event-title"><%= e.title %></h3>  <% } %>   <div class="event-content-container cf">  <% if (e.media) { %>  <div class="event-media-container <% if (e.body) { %>with-body<% } %>">  <div class="event-media <% if (e.source) { %>with-source<% } %>">  <% if (e.mediaType === \'youtube\') { %>  <iframe class="event-media-youtube" width="100%" height="350" src="<%= e.media %>" frameborder="0" allowfullscreen></iframe>   <% } else if (e.mediaType === \'soundcloud_large\') { %>  <iframe class="event-media-soundcloud" width="100%" height="350" scrolling="no" frameborder="no" src="<%= e.media %>"></iframe>   <% } else if (e.mediaType === \'soundcloud\') { %>  <iframe class="event-media-soundcloud" width="100%" height="166" scrolling="no" frameborder="no" src="<%= e.media %>"></iframe>   <% } else { %>  <img class="event-media-image" src="<%= e.media %>">  <% } %>  </div>   <% if (e.source) { %>  <div class="event-source">  <%= e.source %>  </div>  <% } %>  </div>  <% } %>   <% if (e.body) { %>  <div class="event-body-container <% if (e.media) { %>with-media<% } %>">  <div class="event-body"><%= e.body %></div>  </div>  <% } %>  </div>  </div>  <% }) %>  </div>  </div>  <% }) %>  </div>   <div class="spine-end spine-bottom timeline-bg-color">  <div><div class="spine-color spine-point"></div></div>  </div> </div> '},s=function(i){if(this.options=e.extend({},n,i||{}),!e.isArray(this.options.events)&&!e.isString(this.options.events))throw new Error('"events" data should be provided as a string or array.');if(this.options.keyMapping&&!e.isObject(this.options.keyMapping))throw new Error('"keyMapping" was not provided as an object.');if(!e.isString(this.options.template)&&!e.isFunction(this.options.template))throw new Error('"template" was not provided as a string or function.');if(!e.isString(this.options.csvDelimiter)||1!==this.options.csvDelimiter.length)throw new Error('"csvDelimiter" was not provided as a single character string.');if(!e.isString(this.options.csvQuote)||1!==this.options.csvQuote.length)throw new Error('"csvQuote" was not provided as a single character string.');if(e.isString(this.options.template))try{this.options.template=e.template(this.options.template)}catch(t){throw new Error("Error parsing template string with underscore templating: "+t.message)}if(this.options.descending=!!this.options.descending,this.isBrowser=this.checkBrowser(),this.isBrowser&&!this.options.el)throw new Error('"el" needs to br provided as a string or object.');if(this.el=this.getElement(this.options.el),this.isBrowser&&!this.el)throw new Error('Could not find a valid element from the given "el" option.');e.isString(this.options.events)&&(this.options.events=this.parseCSV(this.options.events,this.options.csvDelimiter,this.options.csvQuote)),this.events=this.mapKeys(this.options.events,this.options.keyMapping),this.events=this.parseEvents(this.events),this.groups=this.groupEvents(this.events),this.groups=this.sortGroups(this.groups,this.options.descending),this.isBrowser&&(this.id=this.el.id||this.uniqueId("timeline"),this.el.id=this.id,this.render())};return e.extend(s.prototype,{render:function(){var i=this;this.el.innerHTML=this.options.template({_:e,groups:this.groups,title:this.options.title,timeline:this}),window.location.hash&&0===window.location.hash.indexOf("#"+this.id)&&this.scrollTo(window.location.hash),e.each(this.el.querySelectorAll("a.event-link"),function(e){e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href");history.pushState(null,null,t),i.scrollTo(t)})}),this.determinePlacements(),this.miniEl=this.getElement("#"+this.id+" .mini-timeline"),this.progressEl=this.getElement("#"+this.id+" .mini-timeline-progress"),document.addEventListener("scroll",e.bind(this.updateProgress,this))},updateProgress:function(){var e=document.body.scrollTop;e>=this.top&&e<=this.bottom?this.miniEl.classList.add("enabled"):this.miniEl.classList.remove("enabled")},getElement:function(e){var i;return this.isBrowser&&e?e.nodeType?e:"string"==typeof e&&(i=document.getElementById(e),!i&&document.querySelector&&(i=document.querySelector(e)),i&&i.nodeType)?i:e[0]&&e[0].nodeType?e[0]:null:null},checkBrowser:function(){return"undefined"!=typeof window&&document},sortGroups:function(i,t){return t=t||!1,i=e.map(i,function(i){return i.events=e.sortBy(i.events,function(e){return e.date.unix()*(t?-1:1)}),i}),e.sortBy(i,function(e){return e.date.unix()*(t?-1:1)})},groupEvents:function(t){var n,s={};return this.groupType=this.determineGroups(this.events),n="groupBy"+this.groupType.charAt(0).toUpperCase()+this.groupType.slice(1),n=this[n],e.each(t,function(t){var o=e.bind(n,this)(t,i);s[o.id]?s[o.id].events.push(t):(s[o.id]=o,s[o.id].events=[t])}),e.values(s)},groupByMonths:function(e,i){return{id:e.date.format("YYYY-MM"),date:i(e.date.format("YYYY-MM"),"YYYY-MM"),display:i(e.date.format("YYYY-MM"),"YYYY-MM").format("MMM, YYYY")}},groupByYears:function(e,i){return{id:e.date.format("YYYY"),date:i(e.date.format("YYYY"),"YYYY"),display:i(e.date.format("YYYY"),"YYYY").format("YYYY")}},groupByDecades:function(e,i){var t=10*Math.floor(e.date.year()/10);return{id:t.toString(),date:i(t.toString(),"YYYY"),display:i(t.toString(),"YYYY").format("YYYY's")}},determineGroups:function(i){var t=function(e){return e.date.unix()},n=e.min(i,t),s=e.max(i,t),o=s.date.diff(n.date,"years");return 2>o?"months":10>o?"years":"decades"},parseEvents:function(t){return e.map(t,e.bind(function(e){var t=i(e.date,this.options.dateFormat);if(!t.isValid())throw new Error('Error parsing date from "'+e.date+'"');return e.date=t,e.id=this.uniqueId(this.makeIdentifier(e.title)),e.mediaType=e.mediaType||this.determineMediaType(e.media),e.dateFormatted=t.format(this.options.displayFormat),e},this))},determineMediaType:function(e){return e?-1!==e.indexOf("youtube.com")?"youtube":-1!==e.indexOf("soundcloud.com")&&-1!==e.indexOf("visual=true")?"soundcloud_large":-1!==e.indexOf("soundcloud.com")?"soundcloud":"image":void 0},determinePlacements:function(){var i=this;this.top=this.el.getBoundingClientRect().top+window.pageYOffset,this.bottom=this.el.getBoundingClientRect().bottom+window.pageYOffset,this.events=e.map(this.events,function(e){return e.el=i.getElement(i.id+"-"+e.id),e.top=e.el.getBoundingClientRect().top+window.pageYOffset,e.bottom=e.el.getBoundingClientRect().bottom+window.pageYOffset,e})},mapKeys:function(i,t){return t=t||{},e.map(i,function(i){var n=e.clone(i);return e.each(t,function(t,s){e.isUndefined(i[t])||t===s||(n[s]=e.clone(i[t]),delete n[t])}),n})},parseCSV:function(i,t,n){t=t||",",n=n||'"';var s=this.regexEscape(t),o=this.regexEscape(n);i=i.replace(/^\s+|\s+$/g,"");for(var r,d=new RegExp("("+s+"|\\r?\\n|\\r|^)(?:"+o+"([^"+o+"]*(?:"+o+o+"[^"+o+"]*)*)"+o+"|([^"+o+s+"\\r\\n]*))","gi"),a=[[]],l=d.exec(i);l;){var c,u=l[1];u.length&&u!==t&&a.push([]),c=l[2]?l[2].replace(new RegExp(""+o+o,"g"),o):l[3],a[a.length-1].push(c.trim()),l=d.exec(i)}if(a.length<=1||!a[0].length)throw new Error("Unable to parse any data from the CSV string provided.");return r=a.shift(),a=e.map(a,function(i){var t={};return e.each(r,function(e,n){t[e]=i[n]}),t})},regexEscape:function(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},makeIdentifier:function(e){return e.toLowerCase().trim().replace(/[^\w ]+/g,"").replace(/ +/g,"-")},scrollTo:function(e,i){i=i||500;var t=this.getElement(e);if(t){var n=document.body,s=n.scrollTop,o=Math.max(0,t.getBoundingClientRect().top+window.pageYOffset-30),r=o-s,d=0,a=40,l=function(){d+=a,n.scrollTop=s+Math.min(1,d/i)*r,i>d&&setTimeout(l,a)};l()}},uniqueId:function(i){return t[i]=e.isUndefined(t[i])?0:t[i]+1,i+"-"+t[i]}}),s});